<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>學習歷程測試 - InU Learning</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
        }
    </style>
</head>

<body class="bg-gray-100">
    <div class="container mx-auto p-6">
        <h1 class="text-2xl font-bold mb-6">學習歷程測試</h1>

        <div class="bg-white p-6 rounded-lg shadow mb-6">
            <h2 class="text-lg font-semibold mb-4">系統狀態</h2>
            <div id="systemStatus"></div>
        </div>

        <div class="bg-white p-6 rounded-lg shadow mb-6">
            <h2 class="text-lg font-semibold mb-4">操作</h2>
            <button id="loginBtn" class="bg-blue-500 text-white px-4 py-2 rounded mr-2">登入 test02</button>
            <button id="loadRecordsBtn" class="bg-green-500 text-white px-4 py-2 rounded mr-2">載入記錄</button>
            <button id="clearBtn" class="bg-red-500 text-white px-4 py-2 rounded">清除緩存</button>
        </div>

        <div class="bg-white p-6 rounded-lg shadow">
            <h2 class="text-lg font-semibold mb-4">學習記錄</h2>
            <div id="recordsContainer">
                <div class="text-gray-500">點擊「載入記錄」開始...</div>
            </div>
        </div>
    </div>

    <script>
        // 認證管理器 (簡化版)
        class SimpleAuthManager {
            getToken() {
                return localStorage.getItem('auth_token');
            }

            setToken(token) {
                localStorage.setItem('auth_token', token);
            }

            isLoggedIn() {
                return !!this.getToken();
            }
        }

        // API 客戶端 (簡化版)
        class SimpleLearningAPI {
            constructor() {
                this.baseURL = '/api/v1/learning';
            }

            getAuthHeaders() {
                const token = localStorage.getItem('auth_token');
                return {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                };
            }

            async getRecentRecords(limit = 5) {
                try {
                    const response = await fetch(`${this.baseURL}/recent?limit=${limit}`, {
                        headers: this.getAuthHeaders()
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                    }

                    return await response.json();
                } catch (error) {
                    console.error('API 錯誤:', error);
                    throw error;
                }
            }
        }

        // 初始化
        const authManager = new SimpleAuthManager();
        const learningAPI = new SimpleLearningAPI();

        function updateSystemStatus() {
            const status = document.getElementById('systemStatus');
            const token = authManager.getToken();

            status.innerHTML = `
                <div class="space-y-2">
                    <div>登入狀態: ${authManager.isLoggedIn() ? '✅ 已登入' : '❌ 未登入'}</div>
                    <div>Token: ${token ? `✅ 存在 (${token.length} 字元)` : '❌ 不存在'}</div>
                    <div>時間: ${new Date().toLocaleString()}</div>
                </div>
            `;
        }

        async function login() {
            const container = document.getElementById('recordsContainer');
            container.innerHTML = '<div class="text-blue-500">登入中...</div>';

            try {
                const response = await fetch('/api/v1/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'test02@test.com',
                        password: 'P@ssw0rd'
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    authManager.setToken(data.access_token);
                    container.innerHTML = '<div class="text-green-500">✅ 登入成功！</div>';
                    updateSystemStatus();
                } else {
                    const error = await response.text();
                    container.innerHTML = `<div class="text-red-500">❌ 登入失敗: ${error}</div>`;
                }
            } catch (error) {
                container.innerHTML = `<div class="text-red-500">❌ 網路錯誤: ${error.message}</div>`;
            }
        }

        async function loadRecords() {
            const container = document.getElementById('recordsContainer');

            if (!authManager.isLoggedIn()) {
                container.innerHTML = '<div class="text-red-500">❌ 請先登入</div>';
                return;
            }

            container.innerHTML = '<div class="text-blue-500">載入記錄中...</div>';

            try {
                const data = await learningAPI.getRecentRecords(5);

                if (data.sessions && data.sessions.length > 0) {
                    container.innerHTML = `
                        <div class="text-green-500 mb-4">✅ 找到 ${data.sessions.length} 筆記錄</div>
                        <div class="space-y-4">
                            ${data.sessions.map(session => `
                                <div class="border p-4 rounded bg-gray-50">
                                    <div class="font-semibold">${session.session_name}</div>
                                    <div class="text-sm text-gray-600">
                                        科目: ${session.subject} | 
                                        題數: ${session.question_count} | 
                                        正確: ${session.correct_count} | 
                                        正確率: ${session.accuracy_rate}%
                                    </div>
                                    <div class="text-xs text-gray-500">
                                        ${new Date(session.start_time).toLocaleString()}
                                    </div>
                                    <button onclick="viewDetails('${session.session_id}')" 
                                            class="mt-2 bg-blue-500 text-white px-3 py-1 rounded text-sm">
                                        查看詳細
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    container.innerHTML = '<div class="text-yellow-500">⚠️ 沒有找到學習記錄</div>';
                }
            } catch (error) {
                container.innerHTML = `<div class="text-red-500">❌ 載入失敗: ${error.message}</div>`;
            }
        }

        function viewDetails(sessionId) {
            window.location.href = `result.html?sessionId=${sessionId}`;
        }

        function clearCache() {
            localStorage.clear();
            sessionStorage.clear();
            location.reload();
        }

        // 事件綁定
        document.addEventListener('DOMContentLoaded', () => {
            updateSystemStatus();

            document.getElementById('loginBtn').addEventListener('click', login);
            document.getElementById('loadRecordsBtn').addEventListener('click', loadRecords);
            document.getElementById('clearBtn').addEventListener('click', clearCache);
        });
    </script>
</body>

</html>