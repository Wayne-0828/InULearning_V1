<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¸¬è©¦å‡ºè€ƒå·åŠŸèƒ½</title>
</head>
<body>
    <h1>æ¸¬è©¦å‡ºè€ƒå·åŠŸèƒ½</h1>
    
    <div>
        <h2>æ¸¬è©¦æ­¥é©Ÿ</h2>
        <ol>
            <li>é»æ“Šã€Œæ¸¬è©¦èªè­‰æª¢æŸ¥ã€æŒ‰éˆ•</li>
            <li>é»æ“Šã€Œæ¸¬è©¦ API è·¯å¾‘æª¢æ¸¬ã€æŒ‰éˆ•</li>
            <li>é»æ“Šã€Œæ¸¬è©¦è¼‰å…¥ä½œæ¥­ã€æŒ‰éˆ•</li>
            <li>é»æ“Šã€Œæ¸¬è©¦å‡ºè€ƒå·æŒ‰éˆ•ã€æŒ‰éˆ•</li>
        </ol>
    </div>
    
    <div style="margin: 20px 0;">
        <button onclick="testAuth()">æ¸¬è©¦èªè­‰æª¢æŸ¥</button>
        <button onclick="testApiPath()">æ¸¬è©¦ API è·¯å¾‘æª¢æ¸¬</button>
        <button onclick="testLoadAssignments()">æ¸¬è©¦è¼‰å…¥ä½œæ¥­</button>
        <button onclick="testQuizBuilder()">æ¸¬è©¦å‡ºè€ƒå·æŒ‰éˆ•</button>
    </div>
    
    <div id="result"></div>

    <script>
        // æ¨¡æ“¬ apiClient
        const apiClient = {
            baseUrl: 'http://localhost/api/v1',
            getToken() {
                return localStorage.getItem('auth_token') || sessionStorage.getItem('auth_token') || '';
            },
            async request(path, options = {}) {
                const url = `${this.baseUrl}${path}`;
                const headers = Object.assign({ 
                    'Content-Type': 'application/json', 
                    'Accept': 'application/json' 
                }, options.headers || {});
                
                const token = this.getToken();
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                    console.log('âœ… ä½¿ç”¨ token:', token.substring(0, 20) + '...');
                } else {
                    console.log('âŒ æ²’æœ‰æ‰¾åˆ° token');
                }
                
                console.log('ğŸŒ ç™¼é€è«‹æ±‚åˆ°:', url);
                console.log('ğŸ“‹ è«‹æ±‚é ­:', headers);
                
                try {
                    const res = await fetch(url, { ...options, headers });
                    console.log('ğŸ“¡ å›æ‡‰ç‹€æ…‹:', res.status, res.statusText);
                    
                    let data = {};
                    try { 
                        data = await res.json(); 
                        console.log('ğŸ“„ å›æ‡‰æ•¸æ“š:', data);
                    } catch (_) {
                        console.log('âŒ ç„¡æ³•è§£æ JSON å›æ‡‰');
                    }
                    
                    if (!res.ok) {
                        throw new Error(data.detail || data.message || 'Request failed');
                    }
                    
                    return data;
                } catch (error) {
                    console.error('âŒ è«‹æ±‚å¤±æ•—:', error);
                    throw error;
                }
            },
            get(path) { return this.request(path, { method: 'GET' }); },
            post(path, body) { return this.request(path, { method: 'POST', body: JSON.stringify(body) }); }
        };

        // æ¨¡æ“¬ teacherAuth
        const teacherAuth = {
            isLoggedIn() {
                const token = this.getToken();
                return token && !this.isTokenExpired(token);
            },
            getToken() {
                return localStorage.getItem('auth_token') || sessionStorage.getItem('auth_token') || '';
            },
            isTokenExpired(token) {
                try {
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    return payload.exp * 1000 < Date.now();
                } catch (error) {
                    return true;
                }
            }
        };

        // æ¸¬è©¦èªè­‰æª¢æŸ¥
        async function testAuth() {
            try {
                console.log('ğŸ” æ¸¬è©¦èªè­‰æª¢æŸ¥...');
                
                // è¨­ç½®æ¸¬è©¦ token
                const testToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiI5IiwiZW1haWwiOiJ0ZWFjaGVyMDFAdGVzdC5jb20iLCJyb2xlIjoidGVhY2hlciIsImV4cCI6MTc1NTQ0MzM4MX0.aku3XAS5TLZ_oX-BrM169PvqKZ2pGbSp__WffgcikeM';
                localStorage.setItem('auth_token', testToken);
                
                const isLoggedIn = teacherAuth.isLoggedIn();
                console.log('âœ… èªè­‰ç‹€æ…‹:', isLoggedIn);
                
                document.getElementById('result').innerHTML = `
                    <div style="color: green; padding: 10px; border: 1px solid green;">
                        âœ… èªè­‰æª¢æŸ¥æˆåŠŸ<br>
                        ç™»å…¥ç‹€æ…‹: ${isLoggedIn ? 'å·²ç™»å…¥' : 'æœªç™»å…¥'}<br>
                        Token: ${testToken.substring(0, 20)}...
                    </div>
                `;
                
            } catch (error) {
                console.error('âŒ èªè­‰æª¢æŸ¥å¤±æ•—:', error);
                document.getElementById('result').innerHTML = `
                    <div style="color: red; padding: 10px; border: 1px solid red;">
                        âŒ èªè­‰æª¢æŸ¥å¤±æ•—<br>
                        éŒ¯èª¤: ${error.message}
                    </div>
                `;
            }
        }

        // æ¸¬è©¦ API è·¯å¾‘æª¢æ¸¬
        async function testApiPath() {
            try {
                console.log('ğŸ” æ¸¬è©¦ API è·¯å¾‘æª¢æ¸¬...');
                
                const apiPath = '/learning/assignments/';
                const response = await apiClient.get(apiPath);
                
                if (response && (Array.isArray(response) || response.items || response.assignments || response.results)) {
                    console.log('âœ… API è·¯å¾‘æª¢æ¸¬æˆåŠŸ:', apiPath);
                    document.getElementById('result').innerHTML = `
                        <div style="color: green; padding: 10px; border: 1px solid green;">
                            âœ… API è·¯å¾‘æª¢æ¸¬æˆåŠŸ<br>
                            è·¯å¾‘: ${apiPath}<br>
                            å›æ‡‰é¡å‹: ${Array.isArray(response) ? 'Array' : 'Object'}<br>
                            æ•¸æ“šé•·åº¦: ${Array.isArray(response) ? response.length : 'N/A'}
                        </div>
                    `;
                } else {
                    throw new Error('å›æ‡‰æ ¼å¼ä¸æ­£ç¢º');
                }
                
            } catch (error) {
                console.error('âŒ API è·¯å¾‘æª¢æ¸¬å¤±æ•—:', error);
                document.getElementById('result').innerHTML = `
                    <div style="color: red; padding: 10px; border: 1px solid red;">
                        âŒ API è·¯å¾‘æª¢æ¸¬å¤±æ•—<br>
                        éŒ¯èª¤: ${error.message}
                    </div>
                `;
            }
        }

        // æ¸¬è©¦è¼‰å…¥ä½œæ¥­
        async function testLoadAssignments() {
            try {
                console.log('ğŸ“š æ¸¬è©¦è¼‰å…¥ä½œæ¥­...');
                
                const data = await apiClient.get('/learning/assignments/');
                const assignments = Array.isArray(data) ? data : (data.items || data.assignments || data.results || []);
                
                if (Array.isArray(assignments)) {
                    console.log('âœ… è¼‰å…¥ä½œæ¥­æˆåŠŸ:', assignments.length, 'å€‹ä½œæ¥­');
                    document.getElementById('result').innerHTML = `
                        <div style="color: green; padding: 10px; border: 1px solid green;">
                            âœ… è¼‰å…¥ä½œæ¥­æˆåŠŸ<br>
                            ä½œæ¥­æ•¸é‡: ${assignments.length}<br>
                            ç¬¬ä¸€å€‹ä½œæ¥­: ${assignments[0] ? assignments[0].title : 'ç„¡'}
                        </div>
                    `;
                } else {
                    throw new Error('ä½œæ¥­æ•¸æ“šæ ¼å¼ä¸æ­£ç¢º');
                }
                
            } catch (error) {
                console.error('âŒ è¼‰å…¥ä½œæ¥­å¤±æ•—:', error);
                document.getElementById('result').innerHTML = `
                    <div style="color: red; padding: 10px; border: 1px solid red;">
                        âŒ è¼‰å…¥ä½œæ¥­å¤±æ•—<br>
                        éŒ¯èª¤: ${error.message}
                    </div>
                `;
            }
        }

        // æ¸¬è©¦å‡ºè€ƒå·æŒ‰éˆ•
        function testQuizBuilder() {
            try {
                console.log('ğŸ“ æ¸¬è©¦å‡ºè€ƒå·æŒ‰éˆ•...');
                
                // æª¢æŸ¥æ˜¯å¦æ‰€æœ‰å¿…è¦çš„å‡½æ•¸éƒ½å­˜åœ¨
                if (typeof openQuizBuilder === 'function') {
                    console.log('âœ… openQuizBuilder å‡½æ•¸å­˜åœ¨');
                } else {
                    console.log('âŒ openQuizBuilder å‡½æ•¸ä¸å­˜åœ¨');
                }
                
                document.getElementById('result').innerHTML = `
                    <div style="color: green; padding: 10px; border: 1px solid green;">
                        âœ… å‡ºè€ƒå·æŒ‰éˆ•æ¸¬è©¦å®Œæˆ<br>
                        æ³¨æ„ï¼šé€™åªæ˜¯å‡½æ•¸å­˜åœ¨æ€§æª¢æŸ¥ï¼Œå¯¦éš›åŠŸèƒ½éœ€è¦åœ¨çœŸå¯¦é é¢ä¸­æ¸¬è©¦
                    </div>
                `;
                
            } catch (error) {
                console.error('âŒ å‡ºè€ƒå·æŒ‰éˆ•æ¸¬è©¦å¤±æ•—:', error);
                document.getElementById('result').innerHTML = `
                    <div style="color: red; padding: 10px; border: 1px solid red;">
                        âŒ å‡ºè€ƒå·æŒ‰éˆ•æ¸¬è©¦å¤±æ•—<br>
                        éŒ¯èª¤: ${error.message}
                    </div>
                `;
            }
        }
    </script>
</body>
</html>
