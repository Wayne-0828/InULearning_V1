<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç°¡å–® API æ¸¬è©¦ - InULearning</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .test-section { margin: 20px 0; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #007bff; }
        .warning { color: #ffc107; }
        .btn { padding: 8px 16px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .log { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; padding: 10px; margin: 10px 0; font-family: monospace; }
        .status { padding: 5px 10px; border-radius: 4px; color: white; font-size: 12px; }
        .status-ok { background: #28a745; }
        .status-error { background: #dc3545; }
    </style>
</head>
<body>
    <h1>ğŸ”— ç°¡å–® API é€£æ¥æ¸¬è©¦</h1>
    
    <div class="test-section">
        <h2>ğŸ“Š é€£æ¥ç‹€æ…‹</h2>
        <div id="connectionStatus">
            <p>æª¢æŸ¥é€£æ¥ç‹€æ…‹...</p>
        </div>
        <button class="btn btn-primary" onclick="checkConnection()">æª¢æŸ¥é€£æ¥</button>
        <button class="btn btn-success" onclick="testLogin()">æ¸¬è©¦ç™»å…¥</button>
    </div>

    <div class="test-section">
        <h2>ğŸ“ æ¸¬è©¦æ—¥èªŒ</h2>
        <button class="btn btn-primary" onclick="clearLogs()">æ¸…é™¤æ—¥èªŒ</button>
        <div id="testLogs"></div>
    </div>

    <script>
        const testLogs = document.getElementById('testLogs');
        const connectionStatus = document.getElementById('connectionStatus');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.createElement('div');
            logDiv.className = `log ${type}`;
            logDiv.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            testLogs.appendChild(logDiv);
            console.log(`[${timestamp}] ${message}`);
        }

        function clearLogs() {
            testLogs.innerHTML = '';
            log('æ—¥èªŒå·²æ¸…é™¤', 'info');
        }

        // æª¢æŸ¥é€£æ¥ç‹€æ…‹
        async function checkConnection() {
            log('ğŸ” é–‹å§‹æª¢æŸ¥é€£æ¥ç‹€æ…‹...', 'info');
            
            const services = [
                { name: 'èªè­‰æœå‹™ (nginxä»£ç†)', url: '/api/v1/auth/health' },
                { name: 'å­¸ç¿’æœå‹™ (nginxä»£ç†)', url: '/api/v1/learning/health' },
                { name: 'é¡Œåº«æœå‹™ (nginxä»£ç†)', url: '/api/v1/questions/health' },
                { name: 'èªè­‰æœå‹™ (ç›´æ¥)', url: 'http://localhost:8001/health' },
                { name: 'æ•™å¸«ç®¡ç†æœå‹™ (ç›´æ¥)', url: 'http://localhost:8007/health' },
                { name: 'å­¸ç¿’æœå‹™ (ç›´æ¥)', url: 'http://localhost:8003/health' },
                { name: 'é¡Œåº«æœå‹™ (ç›´æ¥)', url: 'http://localhost:8002/health' }
            ];
            
            let statusHTML = '<h3>æœå‹™ç‹€æ…‹:</h3>';
            let allHealthy = true;
            
            for (const service of services) {
                try {
                    const response = await fetch(service.url);
                    const isHealthy = response.ok;
                    const statusClass = isHealthy ? 'status-ok' : 'status-error';
                    const statusText = isHealthy ? 'æ­£å¸¸' : 'ç•°å¸¸';
                    
                    statusHTML += `
                        <p>
                            <span class="status ${statusClass}">${statusText}</span>
                            ${service.name}: ${service.url}
                        </p>
                    `;
                    
                    if (!isHealthy) allHealthy = false;
                    
                    log(`${service.name}: ${statusText}`, isHealthy ? 'success' : 'error');
                } catch (error) {
                    statusHTML += `
                        <p>
                            <span class="status status-error">é€£æ¥å¤±æ•—</span>
                            ${service.name}: ${service.url}
                        </p>
                    `;
                    allHealthy = false;
                    log(`${service.name}: é€£æ¥å¤±æ•— - ${error.message}`, 'error');
                }
            }
            
            if (allHealthy) {
                statusHTML += '<p style="color: green; font-weight: bold;">ğŸ‰ æ‰€æœ‰æœå‹™éƒ½æ­£å¸¸é‹è¡Œï¼</p>';
                log('âœ… æ‰€æœ‰æœå‹™éƒ½æ­£å¸¸é‹è¡Œ', 'success');
            } else {
                statusHTML += '<p style="color: red; font-weight: bold;">âš ï¸ éƒ¨åˆ†æœå‹™æœ‰å•é¡Œ</p>';
                log('âš ï¸ éƒ¨åˆ†æœå‹™æœ‰å•é¡Œ', 'warning');
            }
            
            connectionStatus.innerHTML = statusHTML;
        }

        // æ¸¬è©¦ç™»å…¥
        async function testLogin() {
            log('ğŸ” é–‹å§‹æ¸¬è©¦ç™»å…¥...', 'info');
            
            try {
                // ä½¿ç”¨ nginx ä»£ç†è·¯å¾‘
                const response = await fetch('/api/v1/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: 'teacher@example.com',
                        password: 'password123'
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    log('âœ… ç™»å…¥æˆåŠŸï¼', 'success');
                    log(`ğŸ“‹ å›æ‡‰æ•¸æ“š: ${JSON.stringify(data, null, 2)}`, 'info');
                } else {
                    const errorData = await response.json();
                    log(`âŒ ç™»å…¥å¤±æ•—: ${response.status} - ${JSON.stringify(errorData)}`, 'error');
                }
            } catch (error) {
                log(`âŒ ç™»å…¥è«‹æ±‚å¤±æ•—: ${error.message}`, 'error');
                
                if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                    log('ğŸ’¡ é€™é€šå¸¸æ˜¯ CORS å•é¡Œï¼Œè«‹æª¢æŸ¥ï¼š', 'warning');
                    log('1. å¾Œç«¯æœå‹™æ˜¯å¦æ­£åœ¨é‹è¡Œ', 'warning');
                    log('2. ç€è¦½å™¨æ§åˆ¶å°æ˜¯å¦æœ‰ CORS éŒ¯èª¤', 'warning');
                    log('3. å˜—è©¦ä½¿ç”¨ Postman æˆ– curl æ¸¬è©¦ API', 'warning');
                }
            }
        }

        // é é¢è¼‰å…¥å®Œæˆå¾Œçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            log('ğŸš€ ç°¡å–® API æ¸¬è©¦é é¢è¼‰å…¥å®Œæˆ', 'success');
            log('ğŸ’¡ é»æ“Š "æª¢æŸ¥é€£æ¥" é–‹å§‹æ¸¬è©¦', 'info');
        });
    </script>
</body>
</html>
