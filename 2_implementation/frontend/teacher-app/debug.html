<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èª¿è©¦é é¢ - InULearning</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .debug-section { margin: 20px 0; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .log { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; padding: 10px; margin: 10px 0; font-family: monospace; }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #007bff; }
        .warning { color: #ffc107; }
        button { padding: 8px 16px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .btn-danger { background: #dc3545; color: white; }
        .hidden { display: none; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .card { background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0; }
        .stat-card { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; text-align: center; }
        .stat-number { font-size: 2rem; font-weight: bold; color: #007bff; }
        .stat-label { color: #6c757d; margin-top: 5px; }
    </style>
</head>
<body>
    <h1>ğŸ” å­¸ç”Ÿåˆ†æåŠŸèƒ½èª¿è©¦é é¢</h1>
    
    <div class="debug-section">
        <h2>ğŸ“Š èª¿è©¦æ§åˆ¶å°</h2>
        <button class="btn-primary" onclick="checkScriptLoading()">æª¢æŸ¥è…³æœ¬è¼‰å…¥</button>
        <button class="btn-success" onclick="testClassDefinition()">æ¸¬è©¦é¡å®šç¾©</button>
        <button class="btn-warning" onclick="testInstanceCreation()">æ¸¬è©¦å¯¦ä¾‹å‰µå»º</button>
        <button class="btn-danger" onclick="clearLogs()">æ¸…é™¤æ—¥èªŒ</button>
        <button class="btn-primary" onclick="testFullFunctionality()">æ¸¬è©¦å®Œæ•´åŠŸèƒ½</button>
    </div>

    <div class="debug-section">
        <h2>ğŸ“ èª¿è©¦æ—¥èªŒ</h2>
        <div id="debugLogs"></div>
    </div>

    <!-- å­¸ç”Ÿåˆ†æåŠŸèƒ½å€åŸŸ -->
    <div class="debug-section">
        <h2>ğŸ“ å­¸ç”Ÿåˆ†æåŠŸèƒ½</h2>
        
        <!-- ç­ç´šé¸æ“‡å€åŸŸ -->
        <div class="card">
            <h3>ç­ç´šé¸æ“‡</h3>
            <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 20px;">
                <label for="classSelector">é¸æ“‡ç­ç´š:</label>
                <select id="classSelector" style="padding: 8px; border: 1px solid #dee2e6; border-radius: 4px; min-width: 200px;">
                    <option value="">è«‹é¸æ“‡ç­ç´š...</option>
                </select>
                <button id="refreshBtn" class="btn-primary">é‡æ–°æ•´ç†</button>
            </div>
        </div>

        <!-- è¼‰å…¥æŒ‡ç¤ºå™¨ -->
        <div id="loadingIndicator" class="hidden">
            <div class="card" style="text-align: center; padding: 40px;">
                <div style="font-size: 2rem; margin-bottom: 10px;">â³</div>
                <p>è¼‰å…¥ä¸­...</p>
            </div>
        </div>

        <!-- ç­ç´šæ¦‚è¦½å…§å®¹ -->
        <div id="classOverviewContent" class="hidden">
            <div class="card">
                <h3>ç­ç´šæ¦‚è¦½</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalStudents">0</div>
                        <div class="stat-label">å­¸ç”Ÿç¸½æ•¸</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="averageAccuracy">0%</div>
                        <div class="stat-label">å¹³å‡æ­£ç¢ºç‡</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="averageSpeed">0 ç§’/é¡Œ</div>
                        <div class="stat-label">å¹³å‡ç­”é¡Œé€Ÿåº¦</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalSessions">0</div>
                        <div class="stat-label">ç¸½å­¸ç¿’æœƒè©±</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å­¸ç”Ÿåˆ—è¡¨å…§å®¹ -->
        <div id="studentListContent" class="hidden">
            <div class="card">
                <h3>å­¸ç”Ÿåˆ—è¡¨</h3>
                <div id="studentGrid" class="grid"></div>
            </div>
        </div>

        <!-- ç„¡æ•¸æ“šç‹€æ…‹ -->
        <div id="noDataState" class="hidden">
            <div class="card" style="text-align: center; padding: 40px;">
                <div style="font-size: 2rem; margin-bottom: 10px;">ğŸ“š</div>
                <p>å°šç„¡ç­ç´šæ•¸æ“š</p>
            </div>
        </div>

        <!-- éŒ¯èª¤ç‹€æ…‹ -->
        <div id="errorState" class="hidden">
            <div class="card" style="text-align: center; padding: 40px; border-color: #dc3545;">
                <div style="font-size: 2rem; margin-bottom: 10px; color: #dc3545;">âŒ</div>
                <p id="errorMessage">è¼‰å…¥å¤±æ•—</p>
                <button id="retryBtn" class="btn-primary">é‡è©¦</button>
            </div>
        </div>
    </div>

    <div class="debug-section">
        <h2>ğŸ§ª åŠŸèƒ½æ¸¬è©¦</h2>
        <div id="testArea">
            <p>é»æ“Šä¸Šæ–¹æŒ‰éˆ•é–‹å§‹æ¸¬è©¦...</p>
        </div>
    </div>

    <div class="debug-section">
        <h2>ğŸ“ é é¢å…ƒç´ </h2>
        <div id="pageElements">
            <p>æª¢æŸ¥é é¢å…ƒç´ è¼‰å…¥ç‹€æ…‹...</p>
        </div>
    </div>

    <script>
        // èª¿è©¦æ—¥èªŒç³»çµ±
        const debugLogs = document.getElementById('debugLogs');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.createElement('div');
            logDiv.className = `log ${type}`;
            logDiv.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            debugLogs.appendChild(logDiv);
            
            // åŒæ™‚è¼¸å‡ºåˆ°ç€è¦½å™¨æ§åˆ¶å°
            console.log(`[${timestamp}] ${message}`);
            
            // è‡ªå‹•æ»¾å‹•åˆ°åº•éƒ¨
            debugLogs.scrollTop = debugLogs.scrollHeight;
        }

        function clearLogs() {
            debugLogs.innerHTML = '';
            log('æ—¥èªŒå·²æ¸…é™¤', 'info');
        }

        // æª¢æŸ¥è…³æœ¬è¼‰å…¥ç‹€æ…‹
        function checkScriptLoading() {
            log('ğŸ” é–‹å§‹æª¢æŸ¥è…³æœ¬è¼‰å…¥ç‹€æ…‹...', 'info');
            
            // æª¢æŸ¥ StudentsAnalysisManager æ˜¯å¦å·²å®šç¾©
            if (typeof StudentsAnalysisManager !== 'undefined') {
                log('âœ… StudentsAnalysisManager é¡å·²æˆåŠŸè¼‰å…¥', 'success');
                log(`ğŸ“‹ é¡çš„é¡å‹: ${typeof StudentsAnalysisManager}`, 'info');
                log(`ğŸ“‹ é¡çš„æ§‹é€ å‡½æ•¸: ${StudentsAnalysisManager.constructor.name}`, 'info');
            } else {
                log('âŒ StudentsAnalysisManager é¡æœªå®šç¾©', 'error');
                log('ğŸ” æª¢æŸ¥ window å°è±¡...', 'info');
                
                // æª¢æŸ¥ window å°è±¡ä¸Šçš„å±¬æ€§
                const windowProps = Object.getOwnPropertyNames(window).filter(prop => 
                    prop.toLowerCase().includes('student') || 
                    prop.toLowerCase().includes('analysis') ||
                    prop.toLowerCase().includes('manager')
                );
                
                if (windowProps.length > 0) {
                    log(`ğŸ” ç™¼ç¾ç›¸é—œå±¬æ€§: ${windowProps.join(', ')}`, 'warning');
                } else {
                    log('ğŸ” æœªç™¼ç¾ç›¸é—œå±¬æ€§', 'warning');
                }
            }
        }

        // æ¸¬è©¦é¡å®šç¾©
        function testClassDefinition() {
            log('ğŸ§ª é–‹å§‹æ¸¬è©¦é¡å®šç¾©...', 'info');
            
            if (typeof StudentsAnalysisManager === 'undefined') {
                log('âŒ StudentsAnalysisManager æœªå®šç¾©ï¼Œç„¡æ³•æ¸¬è©¦', 'error');
                return;
            }
            
            try {
                // æª¢æŸ¥é¡çš„å±¬æ€§
                log(`ğŸ“‹ é¡åç¨±: ${StudentsAnalysisManager.name}`, 'info');
                log(`ğŸ“‹ é¡çš„é•·åº¦: ${StudentsAnalysisManager.length}`, 'info');
                
                // æª¢æŸ¥åŸå‹
                const prototype = StudentsAnalysisManager.prototype;
                log(`ğŸ“‹ åŸå‹æ–¹æ³•æ•¸é‡: ${Object.getOwnPropertyNames(prototype).length}`, 'info');
                
                // åˆ—å‡ºä¸»è¦æ–¹æ³•
                const methods = Object.getOwnPropertyNames(prototype).filter(name => 
                    name !== 'constructor' && typeof prototype[name] === 'function'
                );
                log(`ğŸ“‹ ä¸»è¦æ–¹æ³•: ${methods.join(', ')}`, 'info');
                
                log('âœ… é¡å®šç¾©æ¸¬è©¦å®Œæˆ', 'success');
            } catch (error) {
                log(`âŒ é¡å®šç¾©æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
            }
        }

        // æ¸¬è©¦å¯¦ä¾‹å‰µå»º
        function testInstanceCreation() {
            log('ğŸ§ª é–‹å§‹æ¸¬è©¦å¯¦ä¾‹å‰µå»º...', 'info');
            
            if (typeof StudentsAnalysisManager === 'undefined') {
                log('âŒ StudentsAnalysisManager æœªå®šç¾©ï¼Œç„¡æ³•å‰µå»ºå¯¦ä¾‹', 'error');
                return;
            }
            
            try {
                const instance = new StudentsAnalysisManager();
                log('âœ… å¯¦ä¾‹å‰µå»ºæˆåŠŸ', 'success');
                log(`ğŸ“‹ å¯¦ä¾‹é¡å‹: ${typeof instance}`, 'info');
                log(`ğŸ“‹ å¯¦ä¾‹æ§‹é€ å‡½æ•¸: ${instance.constructor.name}`, 'info');
                
                // æª¢æŸ¥å¯¦ä¾‹å±¬æ€§
                const instanceProps = Object.getOwnPropertyNames(instance);
                log(`ğŸ“‹ å¯¦ä¾‹å±¬æ€§: ${instanceProps.join(', ')}`, 'info');
                
                // æª¢æŸ¥åˆå§‹åŒ–ç‹€æ…‹
                if (instance.isInitialized !== undefined) {
                    log(`ğŸ“‹ åˆå§‹åŒ–ç‹€æ…‹: ${instance.isInitialized}`, 'info');
                }
                
                return instance;
            } catch (error) {
                log(`âŒ å¯¦ä¾‹å‰µå»ºå¤±æ•—: ${error.message}`, 'error');
                log(`ğŸ“‹ éŒ¯èª¤å †ç–Š: ${error.stack}`, 'error');
                return null;
            }
        }

        // æ¸¬è©¦å®Œæ•´åŠŸèƒ½
        function testFullFunctionality() {
            log('ğŸ§ª é–‹å§‹æ¸¬è©¦å®Œæ•´åŠŸèƒ½...', 'info');
            
            const manager = testInstanceCreation();
            if (!manager) {
                log('âŒ ç„¡æ³•å‰µå»ºç®¡ç†å™¨å¯¦ä¾‹', 'error');
                return;
            }
            
            try {
                // æ¸¬è©¦ç­ç´šè¼‰å…¥
                log('ğŸ“š æ¸¬è©¦ç­ç´šè¼‰å…¥...', 'info');
                manager.loadClasses();
                
                // ç­‰å¾…ç­ç´šè¼‰å…¥å®Œæˆå¾Œæ¸¬è©¦å…¶ä»–åŠŸèƒ½
                setTimeout(() => {
                    log('ğŸ“Š æª¢æŸ¥ç­ç´šé¸æ“‡ç‹€æ…‹...', 'info');
                    
                    if (manager.currentClassId) {
                        log(`âœ… å·²é¸æ“‡ç­ç´š ID: ${manager.currentClassId}`, 'success');
                        
                        // æ¸¬è©¦ç­ç´šæ¦‚è¦½
                        log('ğŸ“Š æ¸¬è©¦ç­ç´šæ¦‚è¦½...', 'info');
                        manager.loadClassOverview(manager.currentClassId);
                        
                        // æ¸¬è©¦å­¸ç”Ÿåˆ—è¡¨
                        setTimeout(() => {
                            log('ğŸ‘¥ æ¸¬è©¦å­¸ç”Ÿåˆ—è¡¨...', 'info');
                            manager.loadStudents(manager.currentClassId);
                            
                            // æ¸¬è©¦è¦–åœ–åˆ‡æ›
                            setTimeout(() => {
                                log('ğŸ”„ æ¸¬è©¦è¦–åœ–åˆ‡æ›...', 'info');
                                manager.switchView('list');
                                
                                setTimeout(() => {
                                    manager.switchView('overview');
                                    log('âœ… æ‰€æœ‰åŠŸèƒ½æ¸¬è©¦å®Œæˆï¼', 'success');
                                }, 1000);
                            }, 1000);
                        }, 1000);
                    } else {
                        log('âš ï¸ æ²’æœ‰é¸ä¸­çš„ç­ç´šï¼Œå˜—è©¦æ‰‹å‹•é¸æ“‡...', 'warning');
                        
                        // å˜—è©¦æ‰‹å‹•é¸æ“‡ç¬¬ä¸€å€‹ç­ç´š
                        const selector = document.getElementById('classSelector');
                        if (selector && selector.options.length > 1) {
                            const firstOption = selector.options[1]; // è·³éç¬¬ä¸€å€‹ç©ºé¸é …
                            selector.value = firstOption.value;
                            manager.currentClassId = firstOption.value;
                            log(`âœ… æ‰‹å‹•é¸æ“‡ç­ç´š: ${firstOption.textContent}`, 'success');
                            
                            // è§¸ç™¼è®Šæ›´äº‹ä»¶
                            const event = new Event('change', { bubbles: true });
                            selector.dispatchEvent(event);
                        } else {
                            log('âŒ ç­ç´šé¸æ“‡å™¨æ²’æœ‰å¯ç”¨é¸é …', 'error');
                        }
                    }
                }, 1500);
                
                log('âœ… å®Œæ•´åŠŸèƒ½æ¸¬è©¦å·²å•Ÿå‹•', 'success');
            } catch (error) {
                log(`âŒ å®Œæ•´åŠŸèƒ½æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
            }
        }

        // æª¢æŸ¥é é¢å…ƒç´ 
        function checkPageElements() {
            log('ğŸ” æª¢æŸ¥é é¢å…ƒç´ ...', 'info');
            
            const elements = [
                'classSelector',
                'refreshBtn',
                'loadingIndicator',
                'classOverviewContent',
                'studentListContent',
                'noDataState',
                'errorState'
            ];
            
            let foundCount = 0;
            elements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    log(`âœ… å…ƒç´  ${id} å­˜åœ¨`, 'success');
                    foundCount++;
                } else {
                    log(`âŒ å…ƒç´  ${id} ä¸å­˜åœ¨`, 'error');
                }
            });
            
            if (foundCount === elements.length) {
                log(`ğŸ‰ æ‰€æœ‰ ${foundCount} å€‹å¿…è¦å…ƒç´ éƒ½å·²æ‰¾åˆ°ï¼`, 'success');
            } else {
                log(`âš ï¸ åªæ‰¾åˆ° ${foundCount}/${elements.length} å€‹å¿…è¦å…ƒç´ `, 'warning');
            }
        }

        // é é¢è¼‰å…¥å®Œæˆå¾Œçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            log('ğŸš€ é é¢è¼‰å…¥å®Œæˆ', 'success');
            log('ğŸ” é–‹å§‹è‡ªå‹•æª¢æŸ¥...', 'info');
            
            // å»¶é²æª¢æŸ¥ï¼Œç¢ºä¿è…³æœ¬æœ‰æ™‚é–“è¼‰å…¥
            setTimeout(() => {
                checkScriptLoading();
                checkPageElements();
            }, 1000);
        });

        // éŒ¯èª¤è™•ç†
        window.addEventListener('error', (e) => {
            log(`âŒ JavaScript éŒ¯èª¤: ${e.message}`, 'error');
            log(`ğŸ“‹ éŒ¯èª¤æ–‡ä»¶: ${e.filename}`, 'error');
            log(`ğŸ“‹ éŒ¯èª¤è¡Œè™Ÿ: ${e.lineno}`, 'error');
        });

        // æœªè™•ç†çš„ Promise æ‹’çµ•
        window.addEventListener('unhandledrejection', (e) => {
            log(`âŒ æœªè™•ç†çš„ Promise æ‹’çµ•: ${e.reason}`, 'error');
        });

        // å®šæœŸæª¢æŸ¥è…³æœ¬è¼‰å…¥ç‹€æ…‹
        let checkCount = 0;
        const maxChecks = 10;
        const checkInterval = setInterval(() => {
            checkCount++;
            if (typeof StudentsAnalysisManager !== 'undefined') {
                log(`âœ… è…³æœ¬åœ¨ç¬¬ ${checkCount} æ¬¡æª¢æŸ¥æ™‚è¼‰å…¥æˆåŠŸ`, 'success');
                clearInterval(checkInterval);
            } else if (checkCount >= maxChecks) {
                log(`âŒ è…³æœ¬è¼‰å…¥è¶…æ™‚ (${maxChecks} æ¬¡æª¢æŸ¥)`, 'error');
                clearInterval(checkInterval);
            } else {
                log(`â³ ç¬¬ ${checkCount} æ¬¡æª¢æŸ¥: è…³æœ¬å°šæœªè¼‰å…¥...`, 'warning');
            }
        }, 500);
    </script>

    <!-- è¼‰å…¥å­¸ç”Ÿåˆ†æç®¡ç†å™¨ -->
    <script src="js/students-enhanced.js"></script>
</body>
</html>
