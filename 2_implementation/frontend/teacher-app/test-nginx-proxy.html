<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nginx ä»£ç†æ¸¬è©¦ - InULearning</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .test-section { margin: 20px 0; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #007bff; }
        .warning { color: #ffc107; }
        .btn { padding: 8px 16px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .log { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; padding: 10px; margin: 10px 0; font-family: monospace; }
        .status { padding: 5px 10px; border-radius: 4px; color: white; font-size: 12px; }
        .status-ok { background: #28a745; }
        .status-error { background: #dc3545; }
        .status-warning { background: #ffc107; color: black; }
    </style>
</head>
<body>
    <h1>ğŸ”— Nginx ä»£ç† API æ¸¬è©¦</h1>
    
    <div class="test-section">
        <h2>ğŸ“Š Nginx ä»£ç†ç‹€æ…‹</h2>
        <div id="proxyStatus">
            <p>æª¢æŸ¥ nginx ä»£ç†ç‹€æ…‹...</p>
        </div>
        <button class="btn btn-primary" onclick="checkNginxProxy()">æª¢æŸ¥ Nginx ä»£ç†</button>
        <button class="btn btn-success" onclick="testAuthAPI()">æ¸¬è©¦èªè­‰ API</button>
        <button class="btn btn-warning" onclick="testTeacherAPI()">æ¸¬è©¦æ•™å¸« API</button>
    </div>

    <div class="test-section">
        <h2>ğŸ“ æ¸¬è©¦æ—¥èªŒ</h2>
        <button class="btn btn-primary" onclick="clearLogs()">æ¸…é™¤æ—¥èªŒ</button>
        <div id="testLogs"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ’¡ è§£æ±ºæ–¹æ¡ˆèªªæ˜</h2>
        <p><strong>å•é¡Œ:</strong> ç€è¦½å™¨ç„¡æ³•ç›´æ¥é€£æ¥å¾Œç«¯æœå‹™ (CORS éŒ¯èª¤)</p>
        <p><strong>è§£æ±ºæ–¹æ¡ˆ:</strong> ä½¿ç”¨ nginx ä»£ç†è·¯å¾‘</p>
        <ul>
            <li>âœ… èªè­‰æœå‹™: <code>/api/v1/auth/*</code></li>
            <li>âœ… å­¸ç¿’æœå‹™: <code>/api/v1/learning/*</code></li>
            <li>âœ… é¡Œåº«æœå‹™: <code>/api/v1/questions/*</code></li>
            <li>âš ï¸ æ•™å¸«ç®¡ç†æœå‹™: éœ€è¦æ·»åŠ  nginx é…ç½®</li>
        </ul>
    </div>

    <script>
        const testLogs = document.getElementById('testLogs');
        const proxyStatus = document.getElementById('proxyStatus');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.createElement('div');
            logDiv.className = `log ${type}`;
            logDiv.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            testLogs.appendChild(logDiv);
            console.log(`[${timestamp}] ${message}`);
        }

        function clearLogs() {
            testLogs.innerHTML = '';
            log('æ—¥èªŒå·²æ¸…é™¤', 'info');
        }

        // æª¢æŸ¥ nginx ä»£ç†ç‹€æ…‹
        async function checkNginxProxy() {
            log('ğŸ” é–‹å§‹æª¢æŸ¥ nginx ä»£ç†ç‹€æ…‹...', 'info');
            
            const proxyEndpoints = [
                { name: 'èªè­‰æœå‹™ä»£ç†', url: 'http://localhost/api/v1/auth/health', expected: 'healthy' },
                { name: 'å­¸ç¿’æœå‹™ä»£ç†', url: 'http://localhost/api/v1/learning/health', expected: 'healthy' },
                { name: 'é¡Œåº«æœå‹™ä»£ç†', url: 'http://localhost/api/v1/questions/health', expected: 'healthy' }
            ];
            
            let statusHTML = '<h3>Nginx ä»£ç†ç‹€æ…‹:</h3>';
            let allWorking = true;
            
            for (const endpoint of proxyEndpoints) {
                try {
                    const response = await fetch(endpoint.url);
                    if (response.ok) {
                        const data = await response.json();
                        const isHealthy = data.status === endpoint.expected;
                        const statusClass = isHealthy ? 'status-ok' : 'status-warning';
                        const statusText = isHealthy ? 'æ­£å¸¸' : 'ç•°å¸¸';
                        
                        statusHTML += `
                            <p>
                                <span class="status ${statusClass}">${statusText}</span>
                                ${endpoint.name}: ${endpoint.url}
                                <br><small>å›æ‡‰: ${JSON.stringify(data)}</small>
                            </p>
                        `;
                        
                        if (!isHealthy) allWorking = false;
                        log(`${endpoint.name}: ${statusText}`, isHealthy ? 'success' : 'warning');
                    } else {
                        statusHTML += `
                            <p>
                                <span class="status status-error">HTTP ${response.status}</span>
                                ${endpoint.name}: ${endpoint.url}
                            </p>
                        `;
                        allWorking = false;
                        log(`${endpoint.name}: HTTP ${response.status}`, 'error');
                    }
                } catch (error) {
                    statusHTML += `
                        <p>
                            <span class="status status-error">é€£æ¥å¤±æ•—</span>
                            ${endpoint.name}: ${endpoint.url}
                            <br><small>éŒ¯èª¤: ${error.message}</small>
                        </p>
                    `;
                    allWorking = false;
                    log(`${endpoint.name}: é€£æ¥å¤±æ•— - ${error.message}`, 'error');
                }
            }
            
            if (allWorking) {
                statusHTML += '<p style="color: green; font-weight: bold;">ğŸ‰ æ‰€æœ‰ nginx ä»£ç†éƒ½æ­£å¸¸å·¥ä½œï¼</p>';
                log('âœ… æ‰€æœ‰ nginx ä»£ç†éƒ½æ­£å¸¸å·¥ä½œ', 'success');
            } else {
                statusHTML += '<p style="color: orange; font-weight: bold;">âš ï¸ éƒ¨åˆ† nginx ä»£ç†æœ‰å•é¡Œ</p>';
                log('âš ï¸ éƒ¨åˆ† nginx ä»£ç†æœ‰å•é¡Œ', 'warning');
            }
            
            proxyStatus.innerHTML = statusHTML;
        }

        // æ¸¬è©¦èªè­‰ API
        async function testAuthAPI() {
            log('ğŸ” æ¸¬è©¦èªè­‰ API (é€šé nginx ä»£ç†)...', 'info');
            
            try {
                // ä½¿ç”¨å®Œæ•´çš„ localhost è·¯å¾‘
                const response = await fetch('http://localhost/api/v1/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: 'teacher@example.com',
                        password: 'password123'
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    log('âœ… èªè­‰ API æ¸¬è©¦æˆåŠŸï¼', 'success');
                    log(`ğŸ“‹ å›æ‡‰æ•¸æ“š: ${JSON.stringify(data, null, 2)}`, 'info');
                } else {
                    const errorData = await response.json();
                    log(`âŒ èªè­‰ API æ¸¬è©¦å¤±æ•—: ${response.status}`, 'error');
                    log(`ğŸ“‹ éŒ¯èª¤è©³æƒ…: ${JSON.stringify(errorData, null, 2)}`, 'error');
                }
            } catch (error) {
                log(`âŒ èªè­‰ API æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
            }
        }

        // æ¸¬è©¦æ•™å¸« API (å¯èƒ½å¤±æ•—ï¼Œå› ç‚ºæ²’æœ‰ä»£ç†é…ç½®)
        async function testTeacherAPI() {
            log('ğŸ‘¨â€ğŸ« æ¸¬è©¦æ•™å¸«ç®¡ç† API...', 'info');
            
            try {
                // å˜—è©¦é€šé nginx ä»£ç† (å¯èƒ½å¤±æ•—)
                const response = await fetch('http://localhost/api/v1/teacher/classes');
                
                if (response.ok) {
                    const data = await response.json();
                    log('âœ… æ•™å¸«ç®¡ç† API æ¸¬è©¦æˆåŠŸï¼', 'success');
                    log(`ğŸ“‹ å›æ‡‰æ•¸æ“š: ${JSON.stringify(data, null, 2)}`, 'info');
                } else {
                    log(`âŒ æ•™å¸«ç®¡ç† API æ¸¬è©¦å¤±æ•—: HTTP ${response.status}`, 'error');
                    if (response.status === 404) {
                        log('ğŸ’¡ é€™è¡¨ç¤º nginx ä¸­æ²’æœ‰æ•™å¸«ç®¡ç†æœå‹™çš„ä»£ç†é…ç½®', 'warning');
                    }
                }
            } catch (error) {
                log(`âŒ æ•™å¸«ç®¡ç† API æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
                log('ğŸ’¡ é€™é€šå¸¸æ˜¯å› ç‚º nginx ä¸­æ²’æœ‰æ•™å¸«ç®¡ç†æœå‹™çš„ä»£ç†é…ç½®', 'warning');
            }
        }

        // é é¢è¼‰å…¥å®Œæˆå¾Œçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            log('ğŸš€ Nginx ä»£ç†æ¸¬è©¦é é¢è¼‰å…¥å®Œæˆ', 'success');
            log('ğŸ’¡ é»æ“Š "æª¢æŸ¥ Nginx ä»£ç†" é–‹å§‹æ¸¬è©¦', 'info');
        });
    </script>
</body>
</html>
