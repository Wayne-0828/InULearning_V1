<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¸ç”Ÿç®¡ç†é é¢æ¸¬è©¦</title>
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            margin: 0;
            padding: 2rem;
            background: #f5f5f5;
        }

        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .test-section {
            margin-bottom: 2rem;
            padding: 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
        }

        .test-section h3 {
            margin-top: 0;
            color: #1f2937;
        }

        .test-button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            margin-right: 1rem;
            margin-bottom: 0.5rem;
        }

        .test-button:hover {
            background: #2563eb;
        }

        .test-result {
            margin-top: 1rem;
            padding: 1rem;
            background: #f9fafb;
            border-radius: 6px;
            font-family: monospace;
            font-size: 0.875rem;
            white-space: pre-wrap;
        }

        .success {
            color: #059669;
        }

        .error {
            color: #dc2626;
        }

        .warning {
            color: #d97706;
        }
    </style>
</head>

<body>
    <div class="test-container">
        <h1>ğŸ§ª å­¸ç”Ÿç®¡ç†é é¢æ¸¬è©¦å·¥å…·</h1>
        <p>é€™å€‹å·¥å…·å¯ä»¥å¹«åŠ©æ¸¬è©¦å­¸ç”Ÿç®¡ç†é é¢çš„ API é€£æ¥å’ŒåŠŸèƒ½ã€‚</p>

        <div class="test-section">
            <h3>ğŸ”— API é€£æ¥æ¸¬è©¦</h3>
            <button class="test-button" onclick="testApiConnection()">æ¸¬è©¦ API é€£æ¥</button>
            <button class="test-button" onclick="testAuthentication()">æ¸¬è©¦èªè­‰</button>
            <div id="apiResult" class="test-result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ“Š å­¸ç¿’è³‡æ–™æ¸¬è©¦</h3>
            <button class="test-button" onclick="testLearningData()">æ¸¬è©¦å­¸ç¿’è¨˜éŒ„</button>
            <button class="test-button" onclick="testStudentData()">æ¸¬è©¦å­¸ç”Ÿè³‡æ–™</button>
            <div id="dataResult" class="test-result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ¯ é é¢åŠŸèƒ½æ¸¬è©¦</h3>
            <button class="test-button" onclick="openStudentsPage()">é–‹å•Ÿå­¸ç”Ÿç®¡ç†é é¢</button>
            <button class="test-button" onclick="openStudentsPageWithClass()">é–‹å•ŸæŒ‡å®šç­ç´šé é¢</button>
            <div id="pageResult" class="test-result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ“‹ æ¸¬è©¦å ±å‘Š</h3>
            <button class="test-button" onclick="runFullTest()">åŸ·è¡Œå®Œæ•´æ¸¬è©¦</button>
            <div id="fullTestResult" class="test-result" style="display: none;"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost/api/v1';
        let authToken = null;

        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.className = `test-result ${type}`;
            element.textContent = message;
        }

        async function testApiConnection() {
            showResult('apiResult', 'æ­£åœ¨æ¸¬è©¦ API é€£æ¥...', 'info');

            try {
                const healthChecks = [
                    { name: 'èªè­‰æœå‹™', url: `${API_BASE}/auth/health` },
                    { name: 'å­¸ç¿’æœå‹™', url: `${API_BASE}/learning/health` },
                    { name: 'é¡Œåº«æœå‹™', url: `${API_BASE}/questions/health` }
                ];

                let results = [];
                for (const check of healthChecks) {
                    try {
                        const response = await fetch(check.url);
                        if (response.ok) {
                            results.push(`âœ… ${check.name}: æ­£å¸¸`);
                        } else {
                            results.push(`âŒ ${check.name}: ç‹€æ…‹ç¢¼ ${response.status}`);
                        }
                    } catch (e) {
                        results.push(`âŒ ${check.name}: é€£æ¥å¤±æ•—`);
                    }
                }

                showResult('apiResult', results.join('\n'), 'success');
            } catch (error) {
                showResult('apiResult', `æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
            }
        }

        async function testAuthentication() {
            showResult('apiResult', 'æ­£åœ¨æ¸¬è©¦èªè­‰...', 'info');

            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'teacher01@test.com',
                        password: 'password123'
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    authToken = data.access_token;
                    showResult('apiResult', `âœ… æ•™å¸«èªè­‰æˆåŠŸ\nğŸ”‘ Token: ${authToken.substring(0, 50)}...`, 'success');
                } else {
                    const error = await response.text();
                    showResult('apiResult', `âŒ èªè­‰å¤±æ•—: ${error}`, 'error');
                }
            } catch (error) {
                showResult('apiResult', `âŒ èªè­‰éŒ¯èª¤: ${error.message}`, 'error');
            }
        }

        async function testLearningData() {
            if (!authToken) {
                showResult('dataResult', 'âš ï¸ è«‹å…ˆåŸ·è¡Œèªè­‰æ¸¬è©¦', 'warning');
                return;
            }

            showResult('dataResult', 'æ­£åœ¨æ¸¬è©¦å­¸ç¿’è³‡æ–™...', 'info');

            try {
                const endpoints = [
                    `${API_BASE}/learning/records`,
                    `${API_BASE}/learning/recent`
                ];

                let results = [];
                for (const url of endpoints) {
                    try {
                        const response = await fetch(url, {
                            headers: { 'Authorization': `Bearer ${authToken}` }
                        });

                        if (response.ok) {
                            const data = await response.json();
                            results.push(`âœ… ${url.split('/').pop()}: ${JSON.stringify(data).substring(0, 100)}...`);
                        } else {
                            results.push(`âŒ ${url.split('/').pop()}: ç‹€æ…‹ç¢¼ ${response.status}`);
                        }
                    } catch (e) {
                        results.push(`âŒ ${url.split('/').pop()}: ${e.message}`);
                    }
                }

                showResult('dataResult', results.join('\n'), 'success');
            } catch (error) {
                showResult('dataResult', `æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
            }
        }

        async function testStudentData() {
            showResult('dataResult', 'æ­£åœ¨ç”Ÿæˆæ¨¡æ“¬å­¸ç”Ÿè³‡æ–™...', 'info');

            const mockStudents = [
                { name: 'ç‹å°æ˜', class: 'ä¸ƒå¹´ä¸‰ç­', score: 85 },
                { name: 'æå°è¯', class: 'ä¸ƒå¹´ä¸‰ç­', score: 92 },
                { name: 'å¼µå°ç¾', class: 'ä¸ƒå¹´ä¸‰ç­', score: 78 },
                { name: 'é™³å°å¼·', class: 'ä¸ƒå¹´ä¸‰ç­', score: 88 },
                { name: 'æ—å°èŠ³', class: 'ä¸ƒå¹´ä¸‰ç­', score: 95 }
            ];

            const result = mockStudents.map(s =>
                `ğŸ‘¤ ${s.name} (${s.class}) - å¹³å‡åˆ†æ•¸: ${s.score}`
            ).join('\n');

            showResult('dataResult', `âœ… æ¨¡æ“¬å­¸ç”Ÿè³‡æ–™ç”ŸæˆæˆåŠŸ:\n${result}`, 'success');
        }

        function openStudentsPage() {
            const url = 'http://localhost:8083/pages/students-enhanced.html';
            window.open(url, '_blank');
            showResult('pageResult', `âœ… å·²é–‹å•Ÿå­¸ç”Ÿç®¡ç†é é¢:\n${url}`, 'success');
        }

        function openStudentsPageWithClass() {
            const url = 'http://localhost:8083/pages/students-enhanced.html?classId=1&class=ä¸ƒå¹´ä¸‰ç­';
            window.open(url, '_blank');
            showResult('pageResult', `âœ… å·²é–‹å•ŸæŒ‡å®šç­ç´šé é¢:\n${url}`, 'success');
        }

        async function runFullTest() {
            showResult('fullTestResult', 'ğŸš€ é–‹å§‹åŸ·è¡Œå®Œæ•´æ¸¬è©¦...\n', 'info');

            let report = [];

            // æ¸¬è©¦ API é€£æ¥
            report.push('=== API é€£æ¥æ¸¬è©¦ ===');
            try {
                const response = await fetch(`${API_BASE}/auth/health`);
                if (response.ok) {
                    report.push('âœ… API æœå‹™æ­£å¸¸');
                } else {
                    report.push('âŒ API æœå‹™ç•°å¸¸');
                }
            } catch (e) {
                report.push('âŒ API æœå‹™ç„¡æ³•é€£æ¥');
            }

            // æ¸¬è©¦èªè­‰
            report.push('\n=== èªè­‰æ¸¬è©¦ ===');
            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'teacher01@test.com',
                        password: 'password123'
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    authToken = data.access_token;
                    report.push('âœ… æ•™å¸«èªè­‰æˆåŠŸ');
                } else {
                    report.push('âŒ æ•™å¸«èªè­‰å¤±æ•—');
                }
            } catch (e) {
                report.push('âŒ èªè­‰æœå‹™éŒ¯èª¤');
            }

            // æ¸¬è©¦å­¸ç¿’è³‡æ–™
            if (authToken) {
                report.push('\n=== å­¸ç¿’è³‡æ–™æ¸¬è©¦ ===');
                try {
                    const response = await fetch(`${API_BASE}/learning/records`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        report.push(`âœ… å­¸ç¿’è¨˜éŒ„ç²å–æˆåŠŸ (${data.total || 0} ç­†è¨˜éŒ„)`);
                    } else {
                        report.push('âŒ å­¸ç¿’è¨˜éŒ„ç²å–å¤±æ•—');
                    }
                } catch (e) {
                    report.push('âŒ å­¸ç¿’æœå‹™éŒ¯èª¤');
                }
            }

            // ç¸½çµ
            report.push('\n=== æ¸¬è©¦ç¸½çµ ===');
            const successCount = report.filter(r => r.includes('âœ…')).length;
            const totalTests = report.filter(r => r.includes('âœ…') || r.includes('âŒ')).length;
            report.push(`ğŸ“Š æˆåŠŸç‡: ${successCount}/${totalTests} (${Math.round(successCount / totalTests * 100)}%)`);

            if (successCount === totalTests) {
                report.push('ğŸ‰ æ‰€æœ‰æ¸¬è©¦é€šéï¼å­¸ç”Ÿç®¡ç†é é¢æ‡‰è©²å¯ä»¥æ­£å¸¸é‹ä½œã€‚');
            } else {
                report.push('âš ï¸ éƒ¨åˆ†æ¸¬è©¦å¤±æ•—ï¼Œé é¢å¯èƒ½æœƒä½¿ç”¨æ¨¡æ“¬è³‡æ–™ã€‚');
            }

            showResult('fullTestResult', report.join('\n'), successCount === totalTests ? 'success' : 'warning');
        }
    </script>
</body>

</html>