<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>學生管理頁面測試</title>
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            margin: 0;
            padding: 2rem;
            background: #f5f5f5;
        }

        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .test-section {
            margin-bottom: 2rem;
            padding: 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
        }

        .test-section h3 {
            margin-top: 0;
            color: #1f2937;
        }

        .test-button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            margin-right: 1rem;
            margin-bottom: 0.5rem;
        }

        .test-button:hover {
            background: #2563eb;
        }

        .test-result {
            margin-top: 1rem;
            padding: 1rem;
            background: #f9fafb;
            border-radius: 6px;
            font-family: monospace;
            font-size: 0.875rem;
            white-space: pre-wrap;
        }

        .success {
            color: #059669;
        }

        .error {
            color: #dc2626;
        }

        .warning {
            color: #d97706;
        }
    </style>
</head>

<body>
    <div class="test-container">
        <h1>🧪 學生管理頁面測試工具</h1>
        <p>這個工具可以幫助測試學生管理頁面的 API 連接和功能。</p>

        <div class="test-section">
            <h3>🔗 API 連接測試</h3>
            <button class="test-button" onclick="testApiConnection()">測試 API 連接</button>
            <button class="test-button" onclick="testAuthentication()">測試認證</button>
            <div id="apiResult" class="test-result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>📊 學習資料測試</h3>
            <button class="test-button" onclick="testLearningData()">測試學習記錄</button>
            <button class="test-button" onclick="testStudentData()">測試學生資料</button>
            <div id="dataResult" class="test-result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>🎯 頁面功能測試</h3>
            <button class="test-button" onclick="openStudentsPage()">開啟學生管理頁面</button>
            <button class="test-button" onclick="openStudentsPageWithClass()">開啟指定班級頁面</button>
            <div id="pageResult" class="test-result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>📋 測試報告</h3>
            <button class="test-button" onclick="runFullTest()">執行完整測試</button>
            <div id="fullTestResult" class="test-result" style="display: none;"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost/api/v1';
        let authToken = null;

        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.className = `test-result ${type}`;
            element.textContent = message;
        }

        async function testApiConnection() {
            showResult('apiResult', '正在測試 API 連接...', 'info');

            try {
                const healthChecks = [
                    { name: '認證服務', url: `${API_BASE}/auth/health` },
                    { name: '學習服務', url: `${API_BASE}/learning/health` },
                    { name: '題庫服務', url: `${API_BASE}/questions/health` }
                ];

                let results = [];
                for (const check of healthChecks) {
                    try {
                        const response = await fetch(check.url);
                        if (response.ok) {
                            results.push(`✅ ${check.name}: 正常`);
                        } else {
                            results.push(`❌ ${check.name}: 狀態碼 ${response.status}`);
                        }
                    } catch (e) {
                        results.push(`❌ ${check.name}: 連接失敗`);
                    }
                }

                showResult('apiResult', results.join('\n'), 'success');
            } catch (error) {
                showResult('apiResult', `測試失敗: ${error.message}`, 'error');
            }
        }

        async function testAuthentication() {
            showResult('apiResult', '正在測試認證...', 'info');

            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'teacher01@test.com',
                        password: 'password123'
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    authToken = data.access_token;
                    showResult('apiResult', `✅ 教師認證成功\n🔑 Token: ${authToken.substring(0, 50)}...`, 'success');
                } else {
                    const error = await response.text();
                    showResult('apiResult', `❌ 認證失敗: ${error}`, 'error');
                }
            } catch (error) {
                showResult('apiResult', `❌ 認證錯誤: ${error.message}`, 'error');
            }
        }

        async function testLearningData() {
            if (!authToken) {
                showResult('dataResult', '⚠️ 請先執行認證測試', 'warning');
                return;
            }

            showResult('dataResult', '正在測試學習資料...', 'info');

            try {
                const endpoints = [
                    `${API_BASE}/learning/records`,
                    `${API_BASE}/learning/recent`
                ];

                let results = [];
                for (const url of endpoints) {
                    try {
                        const response = await fetch(url, {
                            headers: { 'Authorization': `Bearer ${authToken}` }
                        });

                        if (response.ok) {
                            const data = await response.json();
                            results.push(`✅ ${url.split('/').pop()}: ${JSON.stringify(data).substring(0, 100)}...`);
                        } else {
                            results.push(`❌ ${url.split('/').pop()}: 狀態碼 ${response.status}`);
                        }
                    } catch (e) {
                        results.push(`❌ ${url.split('/').pop()}: ${e.message}`);
                    }
                }

                showResult('dataResult', results.join('\n'), 'success');
            } catch (error) {
                showResult('dataResult', `測試失敗: ${error.message}`, 'error');
            }
        }

        async function testStudentData() {
            showResult('dataResult', '正在生成模擬學生資料...', 'info');

            const mockStudents = [
                { name: '王小明', class: '七年三班', score: 85 },
                { name: '李小華', class: '七年三班', score: 92 },
                { name: '張小美', class: '七年三班', score: 78 },
                { name: '陳小強', class: '七年三班', score: 88 },
                { name: '林小芳', class: '七年三班', score: 95 }
            ];

            const result = mockStudents.map(s =>
                `👤 ${s.name} (${s.class}) - 平均分數: ${s.score}`
            ).join('\n');

            showResult('dataResult', `✅ 模擬學生資料生成成功:\n${result}`, 'success');
        }

        function openStudentsPage() {
            const url = 'http://localhost:8083/pages/students-enhanced.html';
            window.open(url, '_blank');
            showResult('pageResult', `✅ 已開啟學生管理頁面:\n${url}`, 'success');
        }

        function openStudentsPageWithClass() {
            const url = 'http://localhost:8083/pages/students-enhanced.html?classId=1&class=七年三班';
            window.open(url, '_blank');
            showResult('pageResult', `✅ 已開啟指定班級頁面:\n${url}`, 'success');
        }

        async function runFullTest() {
            showResult('fullTestResult', '🚀 開始執行完整測試...\n', 'info');

            let report = [];

            // 測試 API 連接
            report.push('=== API 連接測試 ===');
            try {
                const response = await fetch(`${API_BASE}/auth/health`);
                if (response.ok) {
                    report.push('✅ API 服務正常');
                } else {
                    report.push('❌ API 服務異常');
                }
            } catch (e) {
                report.push('❌ API 服務無法連接');
            }

            // 測試認證
            report.push('\n=== 認證測試 ===');
            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'teacher01@test.com',
                        password: 'password123'
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    authToken = data.access_token;
                    report.push('✅ 教師認證成功');
                } else {
                    report.push('❌ 教師認證失敗');
                }
            } catch (e) {
                report.push('❌ 認證服務錯誤');
            }

            // 測試學習資料
            if (authToken) {
                report.push('\n=== 學習資料測試 ===');
                try {
                    const response = await fetch(`${API_BASE}/learning/records`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        report.push(`✅ 學習記錄獲取成功 (${data.total || 0} 筆記錄)`);
                    } else {
                        report.push('❌ 學習記錄獲取失敗');
                    }
                } catch (e) {
                    report.push('❌ 學習服務錯誤');
                }
            }

            // 總結
            report.push('\n=== 測試總結 ===');
            const successCount = report.filter(r => r.includes('✅')).length;
            const totalTests = report.filter(r => r.includes('✅') || r.includes('❌')).length;
            report.push(`📊 成功率: ${successCount}/${totalTests} (${Math.round(successCount / totalTests * 100)}%)`);

            if (successCount === totalTests) {
                report.push('🎉 所有測試通過！學生管理頁面應該可以正常運作。');
            } else {
                report.push('⚠️ 部分測試失敗，頁面可能會使用模擬資料。');
            }

            showResult('fullTestResult', report.join('\n'), successCount === totalTests ? 'success' : 'warning');
        }
    </script>
</body>

</html>