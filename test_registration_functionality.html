<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>註冊功能測試 - InU Learning</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .status-success {
            color: #059669;
        }

        .status-error {
            color: #dc2626;
        }

        .status-warning {
            color: #d97706;
        }
    </style>
</head>

<body class="bg-gray-50 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-center mb-8">🧪 InU Learning 註冊功能測試</h1>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- 手動測試區 -->
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4">📝 手動測試</h2>
                <div class="space-y-3">
                    <a href="http://localhost/register.html" target="_blank"
                        class="block w-full bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600 text-center">
                        打開註冊頁面
                    </a>
                    <a href="http://localhost/login.html" target="_blank"
                        class="block w-full bg-green-500 text-white py-2 px-4 rounded hover:bg-green-600 text-center">
                        打開登入頁面
                    </a>
                    <a href="http://localhost/" target="_blank"
                        class="block w-full bg-purple-500 text-white py-2 px-4 rounded hover:bg-purple-600 text-center">
                        打開首頁
                    </a>
                </div>

                <div class="mt-6">
                    <h3 class="font-semibold mb-2">測試步驟：</h3>
                    <ol class="list-decimal list-inside text-sm space-y-1">
                        <li>打開註冊頁面</li>
                        <li>選擇角色（學生/家長/教師）</li>
                        <li>填寫表單資料</li>
                        <li>檢查即時驗證功能</li>
                        <li>提交註冊</li>
                        <li>確認成功訊息</li>
                    </ol>
                </div>
            </div>

            <!-- 自動測試區 -->
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4">🤖 自動測試</h2>
                <button id="runTests"
                    class="w-full bg-orange-500 text-white py-2 px-4 rounded hover:bg-orange-600 mb-4">
                    開始自動測試
                </button>
                <div id="testResults" class="space-y-2 text-sm"></div>
            </div>
        </div>

        <!-- 測試結果 -->
        <div class="mt-8 bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold mb-4">📊 測試結果</h2>
            <div id="overallResults"></div>
        </div>

        <!-- 故障排除 -->
        <div class="mt-8 bg-yellow-50 border border-yellow-200 p-6 rounded-lg">
            <h2 class="text-xl font-semibold mb-4 text-yellow-800">🔧 故障排除指南</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <h3 class="font-semibold text-yellow-700 mb-2">常見問題：</h3>
                    <ul class="list-disc list-inside text-sm space-y-1">
                        <li>JavaScript 文件 404 錯誤</li>
                        <li>API 連接失敗</li>
                        <li>表單驗證不工作</li>
                        <li>註冊成功但無跳轉</li>
                    </ul>
                </div>
                <div>
                    <h3 class="font-semibold text-yellow-700 mb-2">檢查步驟：</h3>
                    <ul class="list-disc list-inside text-sm space-y-1">
                        <li>檢查開發者工具 Console</li>
                        <li>檢查 Network 標籤</li>
                        <li>確認 Docker 服務運行</li>
                        <li>檢查 nginx 配置</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        class RegistrationTester {
            constructor() {
                this.results = [];
                this.bindEvents();
            }

            bindEvents() {
                document.getElementById('runTests').addEventListener('click', () => {
                    this.runAllTests();
                });
            }

            async runAllTests() {
                this.clearResults();
                this.addResult('開始執行自動測試...', 'info');

                await this.testStaticFiles();
                await this.testAPIEndpoints();
                await this.testRegistrationAPI();

                this.showOverallResults();
            }

            async testStaticFiles() {
                this.addResult('測試靜態文件訪問...', 'info');

                const files = [
                    '/register.html',
                    '/login.html',
                    '/js/register.js',
                    '/js/utils.js',
                    '/js/api-client.js'
                ];

                for (const file of files) {
                    try {
                        const response = await fetch(file);
                        if (response.ok) {
                            this.addResult(`✅ ${file} - HTTP ${response.status}`, 'success');
                        } else {
                            this.addResult(`❌ ${file} - HTTP ${response.status}`, 'error');
                        }
                    } catch (error) {
                        this.addResult(`❌ ${file} - 連接失敗: ${error.message}`, 'error');
                    }
                }
            }

            async testAPIEndpoints() {
                this.addResult('測試 API 端點...', 'info');

                const endpoints = [
                    '/api/v1/auth/register',
                ];

                for (const endpoint of endpoints) {
                    try {
                        // 使用 OPTIONS 請求測試端點是否存在
                        const response = await fetch(endpoint, { method: 'OPTIONS' });
                        this.addResult(`✅ ${endpoint} - 端點可訪問`, 'success');
                    } catch (error) {
                        this.addResult(`❌ ${endpoint} - 連接失敗`, 'error');
                    }
                }
            }

            async testRegistrationAPI() {
                this.addResult('測試註冊 API 功能...', 'info');

                // 測試管理員角色被拒絕
                const adminData = {
                    email: `admin_test_${Date.now()}@test.com`,
                    username: `admin_test_${Date.now()}`,
                    password: 'TestPass123!',
                    role: 'admin',
                    first_name: '測試',
                    last_name: '管理員'
                };

                try {
                    const response = await fetch('/api/v1/auth/register', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(adminData)
                    });

                    if (response.status === 422 || response.status === 400) {
                        const data = await response.json();
                        if (JSON.stringify(data).includes('管理員')) {
                            this.addResult('✅ 管理員角色正確被拒絕', 'success');
                        } else {
                            this.addResult('⚠️ 管理員角色被拒絕但錯誤訊息不正確', 'warning');
                        }
                    } else {
                        this.addResult('❌ 管理員角色未被正確拒絕', 'error');
                    }
                } catch (error) {
                    this.addResult(`❌ 管理員角色測試失敗: ${error.message}`, 'error');
                }

                // 測試有效角色註冊
                const studentData = {
                    email: `student_test_${Date.now()}@test.com`,
                    username: `student_test_${Date.now()}`,
                    password: 'TestPass123!',
                    role: 'student',
                    first_name: '測試',
                    last_name: '學生'
                };

                try {
                    const response = await fetch('/api/v1/auth/register', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(studentData)
                    });

                    if (response.status === 201) {
                        this.addResult('✅ 學生註冊成功', 'success');
                    } else {
                        const data = await response.json();
                        this.addResult(`❌ 學生註冊失敗: ${JSON.stringify(data)}`, 'error');
                    }
                } catch (error) {
                    this.addResult(`❌ 學生註冊測試失敗: ${error.message}`, 'error');
                }
            }

            addResult(message, type) {
                const resultDiv = document.getElementById('testResults');
                const item = document.createElement('div');
                item.className = `status-${type}`;
                item.textContent = message;
                resultDiv.appendChild(item);

                this.results.push({ message, type });
            }

            clearResults() {
                document.getElementById('testResults').innerHTML = '';
                this.results = [];
            }

            showOverallResults() {
                const overallDiv = document.getElementById('overallResults');
                const successCount = this.results.filter(r => r.type === 'success').length;
                const errorCount = this.results.filter(r => r.type === 'error').length;
                const warningCount = this.results.filter(r => r.type === 'warning').length;
                const total = this.results.length - this.results.filter(r => r.type === 'info').length;

                overallDiv.innerHTML = `
                    <div class="grid grid-cols-3 gap-4 text-center">
                        <div class="bg-green-100 p-4 rounded">
                            <div class="text-2xl font-bold text-green-600">${successCount}</div>
                            <div class="text-green-600">成功</div>
                        </div>
                        <div class="bg-yellow-100 p-4 rounded">
                            <div class="text-2xl font-bold text-yellow-600">${warningCount}</div>
                            <div class="text-yellow-600">警告</div>
                        </div>
                        <div class="bg-red-100 p-4 rounded">
                            <div class="text-2xl font-bold text-red-600">${errorCount}</div>
                            <div class="text-red-600">錯誤</div>
                        </div>
                    </div>
                    <div class="mt-4 text-center">
                        <div class="text-lg font-semibold">
                            測試完成：${successCount}/${total} 通過
                            ${errorCount === 0 ? '🎉' : '⚠️'}
                        </div>
                    </div>
                `;
            }
        }

        // 初始化測試器
        new RegistrationTester();
    </script>
</body>

</html>